// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  role         String    @default("provider") // admin, provider, clinic (no pharmacy login)
  status       String    @default("active")
  
  // Provider-specific fields (for role=provider)
  npi          String? // encrypted
  dea          String?
  license      String?
  phone        String? // encrypted
  practice     String?
  
  // Clinic user fields (for role=clinic)
  clinicId     String?
  clinicName   String?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?
  
  // Relationships
  prescriptions Prescription[] @relation("ProviderPrescriptions")
  clinics       ProviderClinic[] // Many-to-many with clinics (for providers)
  auditLogs     AuditLog[]
}

// NEW: Many-to-many relationship between Providers and Clinics
model ProviderClinic {
  id         String   @id @default(cuid())
  providerId String
  clinicId   String
  provider   User     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  clinic     Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  status     String   @default("active") // active, inactive
  createdAt  DateTime @default(now())
  
  @@unique([providerId, clinicId])
  @@index([providerId])
  @@index([clinicId])
}

model Clinic {
  id            String           @id @default(cuid())
  name          String
  address       String?
  phone         String?
  email         String?
  status        String           @default("active")
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  // Relationships
  providers     ProviderClinic[] // Many-to-many with providers
  pharmacies    ClinicPharmacy[]
  patients      Patient[]
  prescriptions Prescription[]
}

model Pharmacy {
  id                   String           @id @default(cuid())
  name                 String
  type                 String           @default("compounding")
  contactName          String?
  phone                String?
  email                String?
  address              String?
  status               String           @default("active")
  supportedMedications String[]         @default([])
  
  // API Integration Configuration
  apiUrl               String? // External pharmacy API endpoint
  apiKey               String? // Encrypted API key
  apiEnabled           Boolean          @default(false)
  
  // Webhook Configuration
  webhookUrl           String? // Our webhook endpoint they should call
  webhookSecret        String? // Secret for HMAC verification
  
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  
  // Relationships
  clinics              ClinicPharmacy[]
  prescriptions        Prescription[]
  products             Product[]
}

model ClinicPharmacy {
  id         String   @id @default(cuid())
  clinicId   String
  pharmacyId String
  clinic     Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([clinicId, pharmacyId])
}

model Patient {
  id            String         @id @default(cuid())
  clinicId      String
  clinicName    String?
  // PHI — all encrypted with AES-256
  firstName     String // encrypted
  lastName      String // encrypted
  dateOfBirth   String? // encrypted
  gender        String?
  phone         String? // encrypted
  email         String? // encrypted
  allergies     String? // encrypted JSON array
  streetAddress String? // encrypted
  city          String?
  state         String?
  zipCode       String? // encrypted
  consentGiven  Boolean        @default(false)
  consentDate   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  clinic        Clinic         @relation(fields: [clinicId], references: [id])
  prescriptions Prescription[]
}

model Prescription {
  id                  String               @id @default(cuid())
  
  // Required Relationships
  providerId          String // REQUIRED: Who created the prescription
  provider            User                 @relation("ProviderPrescriptions", fields: [providerId], references: [id])
  
  patientId           String
  patient             Patient              @relation(fields: [patientId], references: [id])
  
  clinicId            String
  clinic              Clinic               @relation(fields: [clinicId], references: [id])
  clinicName          String?
  clinicAddress       String?
  
  pharmacyId          String? // Optional: assigned by admin
  pharmacy            Pharmacy?            @relation(fields: [pharmacyId], references: [id])
  pharmacyName        String? // encrypted
  
  // Pharmacy API Integration Fields
  externalPharmacyId  String? // Pharmacy's internal RX ID
  apiStatus           String               @default("pending") // pending, sending, sent, failed
  apiSentAt           DateTime?
  apiResponse         String?              @db.Text // JSON response log
  apiError            String?              @db.Text // Error message if failed
  apiRetryCount       Int                  @default(0)
  apiLastRetry        DateTime?
  
  // Patient Info (denormalized for display)
  patientName         String // non-PHI reference
  patientDob          String?
  patientGender       String?
  patientAllergies    String?
  
  // Medication — PHI encrypted
  medicationName      String? // encrypted
  medicationStrength  String? // encrypted
  medicationForm      String?
  quantity            Int                  @default(1)
  directions          String? // encrypted
  refills             Int                  @default(0)
  writtenDate         String?
  daw                 Boolean              @default(false)
  shippingMethod      String               @default("ship_to_patient")
  
  // Provider Info — encrypted (denormalized from User)
  providerName        String? // encrypted
  providerNpi         String? // encrypted
  providerPhone       String? // encrypted
  providerDea         String?
  providerLicense     String?
  providerPractice    String?
  
  // Billing
  amount              Float                @default(0)
  paymentStatus       String               @default("pending")
  
  // Order Status
  orderStatus         String               @default("new") // new, received, processed, shipped, delivered, cancelled
  trackingNumber      String?
  trackingCarrier     String?
  
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  
  // Relationships
  billingTransactions BillingTransaction[]
  statusHistory       PrescriptionStatusHistory[]
  
  @@index([providerId])
  @@index([clinicId])
  @@index([pharmacyId])
  @@index([apiStatus])
  @@index([orderStatus])
}

model Product {
  id                 String    @id @default(cuid())
  pharmacyId         String?
  pharmacy           Pharmacy? @relation(fields: [pharmacyId], references: [id])
  name               String
  medicationStrength String?
  medicationForm     String?
  type               String?
  description        String?
  price              Float?
  status             String    @default("active")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([pharmacyId])
}

model AuditLog {
  id                String   @id @default(cuid())
  userId            String?
  userEmail         String
  userRole          String
  clinicId          String?
  actionType        String // CREATE, READ, UPDATE, DELETE
  resourceType      String // Patient, Prescription, etc.
  resourceId        String?
  phiFieldsAccessed String[] @default([])
  hasPhi            Boolean  @default(false)
  details           String?
  createdAt         DateTime @default(now())
  user              User?    @relation(fields: [userId], references: [id])
}

model BillingTransaction {
  id             String       @id @default(cuid())
  prescriptionId String
  clinicId       String
  clinicName     String?
  type           String       @default("prescription")
  amount         Float        @default(0)
  status         String       @default("pending")
  createdAt      DateTime     @default(now())
  prescription   Prescription @relation(fields: [prescriptionId], references: [id])
}

model PrescriptionStatusHistory {
  id             String       @id @default(cuid())
  prescriptionId String
  statusType     String       // "order" or "payment"
  oldStatus      String?
  newStatus      String
  changedBy      String       // User ID
  changedByName  String       // User display name
  changedByRole  String       // User role (admin, provider, clinic)
  notes          String?      // Optional notes about the change
  createdAt      DateTime     @default(now())
  prescription   Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
}
